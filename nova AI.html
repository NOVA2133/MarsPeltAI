<!doctype html>
<html lang="kk">
<head>
<meta charset="utf-8">
<title>MarsPelt AI Rover</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- AI -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>

<style>
html,body{margin:0;height:100%;background:black;color:#0ff;font-family:monospace;overflow:hidden;}
#wrap{position:relative;width:100%;height:100%;}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}

#hud{
position:absolute;top:10px;left:10px;
background:rgba(0,0,0,.6);
padding:12px;border:2px solid #0ff;border-radius:12px;
}

#cmd{font-size:32px;color:#ff0;}
#status{color:#0f0;}
#ai{position:absolute;bottom:10px;left:10px;font-size:14px;color:#0ff;}

#radar{
position:absolute;right:10px;bottom:10px;
width:200px;height:200px;border:2px solid #0ff;border-radius:50%;
}

#battery{
position:absolute;right:10px;top:10px;
width:120px;height:20px;border:2px solid #0ff;
}
#batteryFill{height:100%;background:#0f0;width:100%;}

button{
position:absolute;left:10px;bottom:10px;
padding:12px 16px;font-size:18px;border:0;border-radius:10px;
background:#0ff;color:black;font-weight:bold;
}
</style>
</head>

<body>
<div id="wrap">
<video id="video" muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="hud">
<div id="status">MarsPelt AI OFFLINE</div>
<div id="cmd">---</div>
</div>

<div id="ai">MARSPELT AUTONOMOUS NAVIGATION SYSTEM</div>

<div id="battery"><div id="batteryFill"></div></div>
<canvas id="radar"></canvas>

<button id="btn">ACTIVATE AI</button>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
</div>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const radar=document.getElementById("radar");
const rctx=radar.getContext("2d");
const statusEl=document.getElementById("status");
const cmdEl=document.getElementById("cmd");
const btn=document.getElementById("btn");
const batteryFill=document.getElementById("batteryFill");
const beep=document.getElementById("beep");

let model,running=false,lastCmd="",battery=100;

function resize(){
 canvas.width=video.videoWidth||1280;
 canvas.height=video.videoHeight||720;
 radar.width=200; radar.height=200;
}
window.onresize=resize;

async function initCamera(){
 const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
 video.srcObject=s;
 await video.play();
 resize();
}

function speak(text){
 const voices=speechSynthesis.getVoices();
 let v=voices.find(v=>v.lang==="kk-KZ")||voices[0];
 const u=new SpeechSynthesisUtterance(text);
 u.voice=v;
 u.lang="kk-KZ";
 u.rate=0.75; u.pitch=0.6; u.volume=1;
 speechSynthesis.cancel();
 speechSynthesis.speak(u);
}

function playBeep(){beep.currentTime=0;beep.play();}

function pickDanger(preds,w,h){
 let best=null,val=0;
 for(const p of preds){
  if(p.score<0.6)continue;
  const [x,y,bw,bh]=p.bbox;
  const area=(bw*bh)/(w*h);
  if(area*p.score>val){val=area*p.score;best={...p,area};}
 }
 return best;
}

function decide(ob,w){
 if(!ob) return {cmd:"GO",say:"Zhol kauipsiz"};
 const [x,,bw]=ob.bbox;
 const cx=x+bw/2;
 const nx=cx/w;
 const close=ob.area>0.12;
 const center=nx>0.4&&nx<0.6;
 if(close&&center) return {cmd:"STOP",say:"Kedergi anyktaldy. Toqta"};
 if(center) return {cmd:"SLOW",say:"Jyljydy bayulat"};
 if(nx<0.4) return {cmd:"RIGHT",say:"On jakka navigatsiya"};
 return {cmd:"LEFT",say:"Sol jakka navigatsiya"};
}

function drawRadar(cmd){
 rctx.clearRect(0,0,200,200);
 rctx.strokeStyle="#0ff";
 rctx.beginPath(); rctx.arc(100,100,90,0,Math.PI*2); rctx.stroke();
 rctx.fillStyle="#0f0";
 if(cmd==="LEFT") rctx.fillRect(20,90,10,20);
 if(cmd==="RIGHT") rctx.fillRect(170,90,10,20);
 if(cmd==="STOP"){rctx.fillStyle="#f00";rctx.fillRect(95,95,10,10);}
}

async function loop(){
 if(!running) return;
 const preds=await model.detect(video);
 const w=canvas.width,h=canvas.height;
 const danger=pickDanger(preds,w,h);
 const d=decide(danger,w);

 ctx.clearRect(0,0,w,h);
 for(const p of preds){
  if(p.score<0.6)continue;
  const [x,y,bw,bh]=p.bbox;
  ctx.strokeStyle="#0f0";ctx.lineWidth=3;
  ctx.strokeRect(x,y,bw,bh);
 }

 cmdEl.textContent=d.cmd;
 drawRadar(d.cmd);

 if(d.cmd!==lastCmd){
  lastCmd=d.cmd;
  playBeep();
  speak(d.say);
 }

 battery-=0.01;
 if(battery<0)battery=100;
 batteryFill.style.width=battery+"%";
 batteryFill.style.background=battery<20?"red":"#0f0";

 requestAnimationFrame(loop);
}

btn.onclick=async()=>{
 btn.disabled=true;
 statusEl.textContent="SYSTEM BOOTING...";
 await initCamera();
 statusEl.textContent="LOADING AI MODEL...";
 model=await cocoSsd.load({base:"lite_mobilenet_v2"});
 statusEl.textContent="MARSPELT AI ONLINE";
 running=true;
 loop();
};
</script>
</body>
</html>